<!-- Draggable Permission Structure Modal -->
<div x-show="showPermissionModal" x-cloak class="fixed inset-0 z-50" aria-labelledby="permission-modal-title" role="dialog" aria-modal="true">
    <!-- Background overlay (click to close) -->
    <div x-show="showPermissionModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-50 dark:bg-gray-900 dark:bg-opacity-50" @click="showPermissionModal = false"></div>

    <!-- Modal panel (draggable) -->
    <div x-show="showPermissionModal"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         x-data="{
             dragging: false,
             startX: 0,
             startY: 0,
             offsetX: 0,
             offsetY: 0,
             posX: null,
             posY: null
         }"
         :style="posX !== null ? 'left: ' + posX + 'px; top: ' + posY + 'px; transform: none;' : ''"
         class="fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden"
         @mousedown.self="dragging = false">

        <!-- Drag handle (header) -->
        <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 px-4 py-3 cursor-move select-none flex items-center justify-between"
             @mousedown.prevent="
                 dragging = true;
                 const rect = $el.parentElement.getBoundingClientRect();
                 if (posX === null) { posX = rect.left; posY = rect.top; }
                 startX = $event.clientX - posX;
                 startY = $event.clientY - posY;
             "
             @mousemove.window="
                 if (dragging) {
                     posX = Math.max(0, Math.min(window.innerWidth - 400, $event.clientX - startX));
                     posY = Math.max(0, Math.min(window.innerHeight - 100, $event.clientY - startY));
                 }
             "
             @mouseup.window="dragging = false">
            <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <h3 class="text-lg font-semibold text-white" id="permission-modal-title">Permission Structure</h3>
            </div>
            <button @click="showPermissionModal = false; posX = null; posY = null" class="text-white/80 hover:text-white">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Modal content (scrollable) -->
        <div class="p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-60px)] space-y-4">
            <!-- System Admins -->
            <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4 border border-purple-200 dark:border-purple-800">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">System Admin</span>
                    <span class="text-xs text-purple-600 dark:text-purple-400">Highest Level</span>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300">Full system access. Can manage all organizations, offices, users, workflows, and system settings.</p>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Group: <code class="px-1 py-0.5 bg-purple-100 dark:bg-purple-900 rounded">system_admins</code> or <code class="px-1 py-0.5 bg-purple-100 dark:bg-purple-900 rounded">is_staff=True</code></p>
            </div>

            <!-- Org Managers -->
            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">Org Manager</span>
                    <span class="text-xs text-blue-600 dark:text-blue-400">Organization Level</span>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300">Full authority over their organization. Can manage <strong>all offices</strong> (including creating sub-offices), all members, and workflows within their organization.</p>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Set via: <code class="px-1 py-0.5 bg-blue-100 dark:bg-blue-900 rounded">OrganizationMembership.role = 'org_manager'</code></p>
            </div>

            <!-- Org Members -->
            <div class="bg-sky-50 dark:bg-sky-900/30 rounded-lg p-4 border border-sky-200 dark:border-sky-800">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200">Org Member</span>
                    <span class="text-xs text-sky-600 dark:text-sky-400">Organization Level</span>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Visibility access only.</strong> Can view packages from all offices in their organization, even without direct office membership. Does not grant workflow participation.</p>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Set via: <code class="px-1 py-0.5 bg-sky-100 dark:bg-sky-900 rounded">OrganizationMembership.role = 'org_member'</code></p>
            </div>

            <!-- Office Managers -->
            <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 border border-green-200 dark:border-green-800">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Office Manager</span>
                    <span class="text-xs text-green-600 dark:text-green-400">Office Level</span>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300">Manage their office and <strong>all descendant offices</strong> (sub-offices, sub-sub-offices, etc.). Can add/remove members, create sub-offices, and participate in workflows assigned to their office.</p>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Set via: <code class="px-1 py-0.5 bg-green-100 dark:bg-green-900 rounded">OfficeMembership.role = 'manager'</code></p>
            </div>

            <!-- Office Members -->
            <div class="bg-amber-50 dark:bg-amber-900/30 rounded-lg p-4 border border-amber-200 dark:border-amber-800">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200">Office Member</span>
                    <span class="text-xs text-amber-600 dark:text-amber-400">Office Level</span>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300">Participates in workflows assigned to their office. Can create packages, take actions (approve, sign, reject, etc.) when their office is assigned to a workflow stage.</p>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Set via: <code class="px-1 py-0.5 bg-amber-100 dark:bg-amber-900 rounded">OfficeMembership.role = 'member'</code></p>
            </div>

            <!-- Key Concepts -->
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Key Concepts</h4>
                <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                    <div class="flex items-start gap-2">
                        <span class="w-2 h-2 mt-1.5 rounded-full bg-indigo-500 flex-shrink-0"></span>
                        <div><strong>Workflow-based permissions:</strong> What actions a user can take (approve, sign, reject) is determined by the workflow design, not by role. If an office is assigned to a "Sign" stage, any member of that office can sign.</div>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="w-2 h-2 mt-1.5 rounded-full bg-green-500 flex-shrink-0"></span>
                        <div><strong>Hierarchical manager scope:</strong> Office Managers have authority over their office and all descendant offices. A parent office manager can manage members in any child office.</div>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="w-2 h-2 mt-1.5 rounded-full bg-blue-500 flex-shrink-0"></span>
                        <div><strong>Independent memberships:</strong> Organization and Office memberships are independent. A user can be an office member without being an org member (and vice versa).</div>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="w-2 h-2 mt-1.5 rounded-full bg-amber-500 flex-shrink-0"></span>
                        <div><strong>Immediate membership:</strong> Office membership is immediate - no approval workflow. Managers add members directly.</div>
                    </div>
                </div>
            </div>

            <!-- Hierarchy diagram -->
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Permission Hierarchy</h4>
                <div class="flex flex-wrap items-center justify-center gap-2 text-xs">
                    <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded font-medium">System Admin</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded font-medium">Org Manager</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded font-medium">Office Manager</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    <span class="px-2 py-1 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 rounded font-medium">Office Member</span>
                </div>
                <p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-2">Org Member provides visibility access only (not shown in hierarchy)</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 flex justify-end border-t border-gray-200 dark:border-gray-600">
            <button type="button" @click="showPermissionModal = false; posX = null; posY = null" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Got it</button>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
</style>
